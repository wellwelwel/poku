name: '🚀 CD — Publish'

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  canary:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: Canary
    steps:
      - name: ➕ Actions - Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ⚙️ Check Commit Message
        run: |
          MESSAGE=$(git log -2 --pretty=%s)
          echo "Commit message: $MESSAGE"

          if [[ "$MESSAGE" =~ build\(deps-dev\) ]] ||
             [[ "$MESSAGE" =~ build\(deps\) ]] ||
             [[ "$MESSAGE" =~ chore\(main\) ]] ||
             [[ "$MESSAGE" =~ chore:\ update\ dependencies ]] ||
             [[ "$MESSAGE" =~ docs: ]] ||
             [[ "$MESSAGE" =~ ci: ]] ||
             [[ "$MESSAGE" =~ cd: ]] ||
             [[ "$MESSAGE" =~ docs\(.*\): ]] ||
             [[ "$MESSAGE" =~ ci\(.*\): ]] ||
             [[ "$MESSAGE" =~ cd\(.*\): ]] ||
             [[ "$MESSAGE" =~ chore\(website\):\ update\ dependencies ]]; then
            echo "Skip publish."
            exit 0
          fi

      - name: ➕ Actions - Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          registry-url: 'https://registry.npmjs.org'

      - name: ➕ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-linux-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-linux-

      - name: 📦 Installing Dependencies
        run: npm ci

      - name: 🚀 Building Poku
        run: npm run build

      - name: ⚙️ Git Hash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}-canary.${SHORT_SHA}" >> $GITHUB_ENV

      - name: ⬆️ Increment Canary Version
        run: npm version $VERSION --no-git-tag-version

      # - name: 📥 Publishing Package
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: npm publish --tag canary --provenance
